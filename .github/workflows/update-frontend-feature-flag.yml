name: Update Frontend Feature Flag
run-name: Update ${{ inputs.feature_flag }} to ${{ inputs.value }} in ${{ inputs.environment }}

on:
  workflow_dispatch:
    inputs:
      feature_flag:
        description: Feature flag to update
        required: true
        type: choice
        options:
          - feature-search-off
          - feature-opportunity-off
          - feature-auth-on
          - feature-saved-opportunities-on
          - feature-saved-searches-on
          - feature-apply-form-prototype-off
          - feature-search-drawer-on
          - feature-search-table-on
          - feature-developer-page-off
          - feature-user-admin-off
          - feature-manage-users-off
      environment:
        description: Target environment
        required: true
        type: choice
        options:
          - dev
          - staging
          - grantee1
      value:
        description: Feature flag value
        required: true
        type: choice
        options:
          - "true"
          - "false"

jobs:
  update-feature-flag:
    name: Update Feature Flag
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Terraform
        uses: ./.github/actions/setup-terraform

      - name: Configure AWS credentials
        uses: ./.github/actions/configure-aws-credentials
        with:
          app_name: frontend
          environment: ${{ inputs.environment }}

      - name: Validate feature flag exists
        id: validate
        run: |
          SSM_PARAM_NAME="/frontend/${{ inputs.environment }}/${{ inputs.feature_flag }}"
          echo "Checking if SSM parameter exists: ${SSM_PARAM_NAME}"

          if aws ssm get-parameter --name "${SSM_PARAM_NAME}" > /dev/null 2>&1; then
            echo "Feature flag found: ${SSM_PARAM_NAME}"
            echo "ssm_param_name=${SSM_PARAM_NAME}" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Feature flag not found in SSM: ${SSM_PARAM_NAME}"
            exit 1
          fi

      - name: Update feature flag value
        run: |
          echo "Updating ${{ steps.validate.outputs.ssm_param_name }} to ${{ inputs.value }}"

          aws ssm put-parameter \
            --name "${{ steps.validate.outputs.ssm_param_name }}" \
            --value "${{ inputs.value }}" \
            --type SecureString \
            --overwrite

          echo "Feature flag updated successfully"

      - name: Restart frontend ECS service
        run: |
          echo "::group::Getting ECS service details"
          terraform -chdir="infra/frontend/service" init -input=false -reconfigure -backend-config="${{ inputs.environment }}.s3.tfbackend"

          CLUSTER_NAME=$(terraform -chdir="infra/frontend/service" output -raw service_cluster_name)
          SERVICE_NAME=$(terraform -chdir="infra/frontend/service" output -raw service_name)
          echo "Cluster: ${CLUSTER_NAME}"
          echo "Service: ${SERVICE_NAME}"
          echo "::endgroup::"

          echo "::group::Forcing new deployment"
          aws ecs update-service \
            --cluster "${CLUSTER_NAME}" \
            --service "${SERVICE_NAME}" \
            --force-new-deployment

          echo "New deployment triggered, waiting for service to stabilize..."
          echo "::endgroup::"

          echo "::group::Waiting for service stability"
          if ! aws ecs wait services-stable --cluster "${CLUSTER_NAME}" --services "${SERVICE_NAME}"; then
            echo "First stability check failed, retrying..."
            aws ecs wait services-stable --cluster "${CLUSTER_NAME}" --services "${SERVICE_NAME}"
          fi
          echo "::endgroup::"

          echo "Frontend service restarted successfully"

      - name: Print current feature flag states
        run: |
          echo "| Feature Flag | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------------|-------|" >> "$GITHUB_STEP_SUMMARY"

          FLAGS=$(yq '.on.workflow_dispatch.inputs.feature_flag.options[]' .github/workflows/update-frontend-feature-flag.yml)

          for FLAG in $FLAGS; do
            VALUE=$(aws ssm get-parameter \
              --name "/frontend/${{ inputs.environment }}/${FLAG}" \
              --with-decryption \
              --query "Parameter.Value" \
              --output text 2>/dev/null || echo "NOT SET")
            echo "| ${FLAG} | ${VALUE} |" >> "$GITHUB_STEP_SUMMARY"
          done

  send-slack-notification:
    if: failure()
    needs: [update-feature-flag]
    uses: ./.github/workflows/send-slack-notification.yml
    secrets: inherit
